<!DOCTYPE html public>
<html>
<head>
  <style>
    .content {
      margin: 20px;
    }

    .editor {
      border: 1px dotted grey;
      padding: 2px;
    }

    .editor:focus {
      border: 1px solid black;
    }

    .caret {
      width: 0px;
      height: 1em;
      border: 1px solid black;
      position: absolute;
    }

    .strikethrough {
      text-decoration: line-through;
    }
  </style>
</head>
<body>
  <div class="content">
    <h2><code>role="textbox"</code> test page</h2>
    <div id="editor" class="editor" style="width: 500px" role="textbox" tabindex=0>Some text in the&nbsp;editor.</div>
    <p>Features yet to be implemented:
      <ul>
        <li class="strikethrough">Cursor anywhere but at the end of text
        <li class="strikethrough">Move cursor using arrow keys
        <li class="strikethrough">Cursor anywhere but at the end of text actually modifies text at that position
        <li class="strikethrough">Delete key deletes text to the right of cursor
        <li>Delete/backspace deletes selection
        <li>Typing replaces selection
        <li>Selection started within text box doesn't extend beyond text box
        <li>Home/end keys move cursor to beginning/end of line
        <li>Select text using keyboard (Shift + arrow keys)
        <li>Skip word using Ctrl + arrow keys (low priority)
        <li>Cursor blinking (low priority)
        <li>...
      </ul>
    </p>
    <p>Known bugs:
      <ul>
        <li class="strikethrough">After cursor placed by mouse click, text typed still goes to end of line
        <li class="strikethrough">Second click does not move cursor
        <li>Deleting all text causes everything to break
        <li>Can't type spaces
        <li>Race condition when backspacing to start of text causing cursor to jitter
      </ul>
    </p>
    <div id="caret" class="caret" style="display: none"/>
  </div>
  <script>
    var editor = document.getElementById("editor");

    editor.addEventListener("keydown", cursor);
    editor.addEventListener("keypress", type);

    // If focus comes from a click, give the click event a chance to set the
    // selection before setting the cursor position
    editor.addEventListener("focus", function() { setTimeout(
      positionAndShowCaret.bind(0, event), 0);
    });
    editor.addEventListener("click", function() {
      console.log("click");
      setTimeout(positionAndShowCaret.bind(0, event), 0);
    });

    editor.addEventListener("blur", hideCaret);

    var cursorOffset = -1;
    var caretX = 0;
    var caretY = 0;
    var cursorActive = false;

    editor.innerHTML = editor.innerHTML.replace(/ /g, "&nbsp;");
    console.log("innerHTML=" + editor.innerHTML);
    var textLength = editor.textContent.length;

    function positionAndShowCaret(event) {
      if (event.type == "click")
        setCaretPositionFromSelection();
      else
        positionCaret(event);

      window.setTimeout(function() {
        showCaret();
      }, 0);
    }

    function positionCaret() {
      if (cursorOffset < 0)
        setCaretPositionFromSelection();
      else
        setSelectionAndCaretPositionFromOffset(cursorOffset);
    }

    function setSelectionAndCaretPositionFromOffset(offset) {
      console.log("offset=" + offset);
      var range = document.createRange();
      range.setStart(editor.firstChild, offset);
      range.setEnd(editor.firstChild, offset);
      var selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      range = document.getSelection().getRangeAt(0);
      range.setStart(editor.firstChild, offset);
      range.setEnd(editor.firstChild, offset);
      console.log("range in setSelectionAndCaretPositionFromOffset: " + range.startOffset + ", " + range.endOffset);
      range = window.getSelection().getRangeAt(0);
      console.log("window.getRangeAt(0) in setSelectionAndCaretPositionFromOffset: " + range.startOffset + ", " + range.endOffset);
      setCaretPositionFromSelection();
    }

    function setCaretPositionFromSelection() {
      var caret = document.getElementById("caret");
      var selection = window.getSelection();
      // TODO(aboxhall): detect selection outside editor and ignore
      if (!selection.rangeCount) {
        console.log("adding range");
        // TODO(aboxhall): use cursorOffset to create the appropriate selection
        // set selection to end of editor
        var range = document.createRange();
        range.selectNodeContents(editor);
        range.collapse(false);
        selection.addRange(range);
      }

      var range = selection.getRangeAt(0);
      if (!range) {
        console.log("no range");
        return;
      }
      console.log("range in setCaretPositionFromSelection: " + range.startOffset + ", " + range.endOffset);
      var x, rect;
      if (range.startOffset != range.endOffset ||
          range.startContainer != range.endContainer) {
        // Only selection ranges with non-zero size have a bounding rect
        rect = range.getBoundingClientRect();
        if (!rect) {
          console.log("no rect");
          return;
        }

        x = rect.right + window.pageXOffset;
        cursorOffset = range.endOffset;
      } else {
        // create a new selection which is >0 width and get the position from that
        var node = range.startContainer;
        var pos = range.startOffset;
        var left = pos;
        var right = pos;
        var max = node.data.length;
        var newRange = document.createRange();

        while (left > 0 || right < max) {
          if (left > 0) {
            left--;
            newRange.setStart(node, left);
            newRange.setEnd(node, pos);
            console.log("range: " + left + ", " + pos);
            rect = newRange.getBoundingClientRect();
            if (rect) {
              x = rect.right;
              console.log("about to set cursorOffset; currently " + cursorOffset);
              cursorOffset = newRange.endOffset;
              console.log("left > 0; cursorOffset=" + cursorOffset);
              break;
            }
          }
          if (right < max) {
            right++;
            newRange.setStart(node, pos);
            newRange.setEnd(node, right);
            rect = newRange.getBoundingClientRect();
            if (rect) {
              x = rect.left;
              cursorOffset = newRange.startOffset;
              console.log("right < max; cursorOffset=" + cursorOffset);
              break;
            }
          }
        }
      }
      caretX = x;
      caretY = rect.top + window.pageYOffset;
      caret.style.left = caretX + 'px';
      caret.style.top = caretY + 'px';
    }

    function showCaret() {
      var caret = document.getElementById("caret");
      cursorActive = true;
      caret.style.display = 'block';
    }

    function hideCaret() {
      var caret = document.getElementById("caret");
      cursorActive = false;
      caret.style.display = 'none';
    }

    function cursor(event) {
      // backspace
      if (event.keyCode == 8) {
        event.preventDefault();
        backspace();
      }

      // delete
      if (event.keyCode == 46)
        del();

      // return
      if (event.keyCode == 13)
        editor.blur();

      // left
      if (event.keyCode == 37 && cursorOffset > 0) {
        cursorOffset--;
        setSelectionAndCaretPositionFromOffset(cursorOffset);
      }

      // right
      if (event.keyCode == 39 && cursorOffset < textLength) {
        cursorOffset++;
        setSelectionAndCaretPositionFromOffset(cursorOffset);
      }

      event.stopPropagation();
      return;
    }

    function backspace() {
      console.log("before backspace; cursorOffset=" + cursorOffset + ", textLength=" + textLength);
      if (textLength == 0)
        return;

      var textContent = editor.textContent;
      console.log("textContent='" + textContent + "'");

      if (cursorOffset == textLength)
        modifiedTextContent = textContent.substring(0, cursorOffset - 1);
      else if (cursorOffset > 0)
        modifiedTextContent = textContent.substring(0, cursorOffset - 1) +
          textContent.substring(cursorOffset, textContent.length);

      if (modifiedTextContent) {
        textLength = modifiedTextContent.length;
        console.log("modifiedTextContent='" + modifiedTextContent + "'");
        editor.textContent = modifiedTextContent;
        cursorOffset--;
      } else {
        textLength = 0;
        console.log("empty text");
        editor.innerHTML = "&nbsp;";
        cursorOffset = 0;
      }
      setSelectionAndCaretPositionFromOffset(cursorOffset);
      console.log("after backspace; cursorOffset=" + cursorOffset + ", textLength=" + textLength);
    }

    function del() {
      if (textLength == 0)
        return;

      var textContent = editor.textContent;
      console.log("textContent='" + textContent + "'");

      if (cursorOffset == 0)
        modifiedTextContent = textContent.substring(1, textLength);
      else if (cursorOffset > 0)
        modifiedTextContent = textContent.substring(0, cursorOffset) +
        textContent.substring(cursorOffset + 1, textContent.length);

      if (modifiedTextContent) {
        textLength = modifiedTextContent.length;
        console.log("modifiedTextContent='" + modifiedTextContent + "'");
        console.log("textLength=" + textLength);
        editor.textContent = modifiedTextContent;
      } else {
        textLength = 0;
        console.log("empty text");
        editor.textContent = "&nbsp;";
        cursorOffset = 0;
      }
      setSelectionAndCaretPositionFromOffset(cursorOffset);
      console.log("textLength=" + textLength);
      console.log("cursorOffset=" + cursorOffset);
    }

    function type(event) {
      if (!event.charCode)
        return;

      if (event.charCode == 32)
        var char = " ";
      else
        var char = String.fromCharCode(event.charCode);

      currentText = editor.textContent;
      if (textLength == 0)
         editor.textContent = char;
      else if (cursorOffset == textLength)
        editor.textContent = currentText + char;
      else
        editor.textContent = currentText.substring(0, cursorOffset) + char + currentText.substring(cursorOffset, textLength);

      textLength = editor.textContent.length;
      cursorOffset++;
      editor.innerHTML = editor.innerHTML.replace(/ /g, "&nbsp;");
      positionCaret();

      event.stopPropagation();
    }
  </script>
</body>
</html>
